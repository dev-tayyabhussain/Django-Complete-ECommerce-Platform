{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - E-Commerce Store{% endblock %}

{% block content %}
<div class="row">
    <!-- Product Images -->
    <div class="col-md-6">
        <div class="product-images">
            <!-- Main Image -->
            <div class="main-image mb-3">
                {% if product.main_image %}
                    <img src="{{ product.main_image.url }}" class="img-fluid rounded" alt="{{ product.name }}" id="mainImage">
                {% else %}
                    <img src="{% static 'images/no-image.svg' %}" class="img-fluid rounded" alt="{{ product.name }}" id="mainImage">
                {% endif %}
            </div>
            
            <!-- Thumbnail Images -->
            {% if product.additional_images.all %}
            <div class="thumbnail-images">
                <div class="row">
                    {% if product.main_image %}
                    <div class="col-3 mb-2">
                        <img src="{{ product.main_image.url }}" class="img-thumbnail thumbnail-img"
                             alt="{{ product.name }}" onclick="changeMainImage(this.src)">
                    </div>
                    {% endif %}
                    {% for image in product.additional_images.all %}
                    <div class="col-3 mb-2">
                        <img src="{{ image.image.url }}" class="img-thumbnail thumbnail-img" 
                             alt="{{ image.alt_text }}" onclick="changeMainImage(this.src)">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Product Information -->
    <div class="col-md-6">
        <div class="product-info">
            <!-- Product Badges -->
            <div class="mb-3">
                {% if product.is_featured %}
                    <span class="badge badge-featured me-2">Featured</span>
                {% endif %}
                {% if product.is_bestseller %}
                    <span class="badge badge-bestseller me-2">Bestseller</span>
                {% endif %}
                {% if product.is_on_sale %}
                    <span class="badge badge-sale me-2">Sale</span>
                {% endif %}
            </div>
            
            <!-- Product Title -->
            <h1 class="product-title mb-3">{{ product.name }}</h1>
            
            <!-- Product Price -->
            <div class="price-section mb-4">
                {% if product.is_on_sale %}
                    <div class="d-flex align-items-center">
                        <span class="sale-price h3 me-3">${{ product.sale_price }}</span>
                        <span class="original-price h5">${{ product.price }}</span>
                        <span class="badge bg-danger ms-3">
                            {{ product.get_discount_percentage }}% OFF
                        </span>
                    </div>
                {% else %}
                    <span class="price h3">${{ product.price }}</span>
                {% endif %}
            </div>
            
            <!-- Product Description -->
            <div class="product-description mb-4">
                <h5>Description</h5>
                <p>{{ product.description|linebreaks }}</p>
            </div>
            
            <!-- Product Details -->
            <div class="product-details mb-4">
                <h5>Product Details</h5>
                <ul class="list-unstyled">
                    <li><strong>Category:</strong> 
                        <a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a>
                    </li>
                    <li><strong>Stock Status:</strong> 
                        <span class="badge stock-badge {% if product.is_in_stock %}in-stock{% else %}out-of-stock{% endif %}">
                            {% if product.is_in_stock %}
                                <i class="fas fa-check"></i> In Stock ({{ product.stock_quantity }} available)
                            {% else %}
                                <i class="fas fa-times"></i> Out of Stock
                            {% endif %}
                        </span>
                    </li>
                    {% if product.tags.all %}
                    <li><strong>Tags:</strong> 
                        {% for tag in product.tags.all %}
                            <a href="{{ tag.get_absolute_url }}" class="badge bg-secondary me-1">{{ tag.name }}</a>
                        {% endfor %}
                    </li>
                    {% endif %}
                    <li><strong>Views:</strong> {{ product.view_count }}</li>
                    <li><strong>Added:</strong> {{ product.created_at|date:"F d, Y" }}</li>
                </ul>
            </div>
            
            <!-- Quantity Selector -->
            {% if product.is_in_stock %}
            <div class="quantity-selector mb-4">
                <label for="quantity" class="form-label"><strong>Quantity:</strong></label>
                <div class="input-group" style="max-width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="{{ product.stock_quantity }}">
                    <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <small class="text-muted">{{ product.stock_quantity }} available</small>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="action-buttons mb-4">
                <div class="d-grid gap-2 d-md-flex">
                    {% if product.is_in_stock %}
                        <button class="btn btn-success btn-lg me-md-2" onclick="addToCartDetail({{ product.id }})">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    {% else %}
                        <button class="btn btn-secondary btn-lg me-md-2" disabled>
                            <i class="fas fa-times"></i> Out of Stock
                        </button>
                    {% endif %}
                    
                    {% if user.is_authenticated %}
                        <button class="btn btn-outline-danger btn-lg" 
                                data-product-id="{{ product.id }}"
                                onclick="toggleWishlist({{ product.id }}, 'add')">
                            <i class="far fa-heart"></i> Add to Wishlist
                        </button>
                    {% else %}
                        <a href="{% url 'store:login' %}" class="btn btn-outline-danger btn-lg">
                            <i class="far fa-heart"></i> Login to Add to Wishlist
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Share Buttons -->
            <div class="share-buttons">
                <h6>Share this product:</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="shareProduct('facebook')">
                        <i class="fab fa-facebook-f"></i> Facebook
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="shareProduct('twitter')">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="shareProduct('whatsapp')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Reviews Section -->
{% if reviews %}
<div class="row mt-5">
    <div class="col-12">
        <h3>Customer Reviews</h3>
        
        <!-- Review Statistics -->
        {% if review_stats %}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Overall Rating</h5>
                        <div class="d-flex align-items-center">
                            <div class="rating me-3">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review_stats.average_rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div>
                                <span class="h4">{{ review_stats.average_rating }}</span>
                                <span class="text-muted">/ 5.0</span>
                                <div class="small text-muted">{{ review_stats.total_reviews }} review{{ review_stats.total_reviews|pluralize }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Rating Distribution</h5>
                        {% for rating in review_stats.rating_distribution %}
                        <div class="d-flex align-items-center mb-2">
                            <span class="me-2">{{ rating.rating }} <i class="fas fa-star text-warning"></i></span>
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar" style="width: {% widthratio rating.count review_stats.total_reviews 100 %}%"></div>
                            </div>
                            <span class="small">{{ rating.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Individual Reviews -->
        <div class="reviews-list">
            {% for review in reviews %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="card-title mb-1">{{ review.title }}</h6>
                            <div class="rating mb-2">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="text-muted small">
                            <div>{{ review.user.username }}</div>
                            <div>{{ review.created_at|date:"M d, Y" }}</div>
                            {% if review.is_verified_purchase %}
                                <span class="badge bg-success">Verified Purchase</span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="card-text">{{ review.comment|linebreaks }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Related Products -->
{% if related_products %}
<div class="row mt-5">
    <div class="col-12">
        <h3>Related Products</h3>
        <div class="row">
            {% for related_product in related_products %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card product-card h-100">
                    {% if related_product.main_image %}
                        <img src="{{ related_product.main_image.url }}" class="card-img-top product-image" alt="{{ related_product.name }}">
                    {% else %}
                        <img src="{% static 'images/no-image.svg' %}" class="card-img-top product-image" alt="{{ related_product.name }}">
                    {% endif %}
                    
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">{{ related_product.name }}</h6>
                        <p class="card-text text-muted small">{{ related_product.short_description|truncatewords:10 }}</p>
                        
                        <div class="mt-auto">
                            <div class="price mb-2">
                                {% if related_product.is_on_sale %}
                                    <span class="sale-price">${{ related_product.sale_price }}</span>
                                    <span class="original-price">${{ related_product.price }}</span>
                                {% else %}
                                    <span>${{ related_product.price }}</span>
                                {% endif %}
                            </div>
                            
                            <a href="{{ related_product.get_absolute_url }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
    function changeMainImage(src) {
        document.getElementById('mainImage').src = src;
    }
    
    function shareProduct(platform) {
        const url = window.location.href;
        const title = '{{ product.name }}';
        const text = 'Check out this product: {{ product.name }}';
        
        let shareUrl = '';
        
        switch(platform) {
            case 'facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                break;
            case 'twitter':
                shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
                break;
            case 'whatsapp':
                shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
                break;
        }
        
        if (shareUrl) {
            window.open(shareUrl, '_blank', 'width=600,height=400');
        }
    }
    
    // Quantity control functions
    function increaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        const maxQuantity = parseInt(quantityInput.getAttribute('max'));
        const currentQuantity = parseInt(quantityInput.value);
        
        if (currentQuantity < maxQuantity) {
            quantityInput.value = currentQuantity + 1;
        }
    }
    
    function decreaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        const currentQuantity = parseInt(quantityInput.value);
        
        if (currentQuantity > 1) {
            quantityInput.value = currentQuantity - 1;
        }
    }
    
    // Add to cart function
    function addToCartDetail(productId) {
        const quantityInput = document.getElementById('quantity');
        const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
        
        // Use the global addToCart function from base.html
        if (typeof window.addToCart === 'function') {
            window.addToCart(productId, quantity);
        } else {
            // Fallback if function is not available
            fetch(`/cart/add/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred. Please try again.', 'error');
            });
        }
    }
    
    // Show message function (fallback)
    function showMessage(message, type) {
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Update wishlist button state if user is authenticated
    {% if user.is_authenticated and in_wishlist %}
    document.addEventListener('DOMContentLoaded', function() {
        const wishlistBtn = document.querySelector('[data-product-id="{{ product.id }}"]');
        if (wishlistBtn) {
            wishlistBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Wishlist';
            wishlistBtn.classList.remove('btn-outline-danger');
            wishlistBtn.classList.add('btn-danger');
        }
    });
    {% endif %}
    
    // Quantity input validation
    document.addEventListener('DOMContentLoaded', function() {
        const quantityInput = document.getElementById('quantity');
        if (quantityInput) {
            quantityInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                const max = parseInt(this.getAttribute('max'));
                const min = parseInt(this.getAttribute('min'));
                
                if (isNaN(value) || value < min) {
                    this.value = min;
                } else if (value > max) {
                    this.value = max;
                }
            });
        }
    });
</script>
{% endblock %}
